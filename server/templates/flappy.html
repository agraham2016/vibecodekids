<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      --game-primary: #74b9ff;
      --game-secondary: #55efc4;
      --game-bg: #0984e3;
      --game-text: #ffffff;
      --game-accent: #ffeaa7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 50%, #55efc4 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #game {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.86.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game"></div>
  <script>
  class FlappyScene extends Phaser.Scene {
    constructor() { super('FlappyScene'); }

    preload() {
      this.load.image('bird', '/assets/sprites/flappy/bird.png');
      this.load.image('pipe', '/assets/sprites/flappy/pipe.png');
      this.load.image('particle', '/assets/sprites/common/particle.png');
      this.load.audio('jumpSfx', '/assets/sounds/jump.wav');
      this.load.audio('hitSfx', '/assets/sounds/hit.wav');
      this.load.audio('coinSfx', '/assets/sounds/coin.wav');
    }

    create() {
      const W = 400, H = 600;
      this.W = W;
      this.H = H;

      const g = this.make.graphics({ add: false });

      if (!this.textures.exists('bird') || this.textures.get('bird').key === '__MISSING') {
        g.fillStyle(0xffeaa7);
        g.fillCircle(16, 16, 14);
        g.fillStyle(0xfdcb6e);
        g.fillCircle(16, 16, 11);
        g.fillStyle(0xffffff);
        g.fillCircle(20, 12, 5);
        g.fillStyle(0x2d3436);
        g.fillCircle(21, 12, 2.5);
        g.fillStyle(0xe17055);
        g.fillTriangle(28, 16, 36, 14, 28, 20);
        g.fillStyle(0xfdcb6e);
        g.fillTriangle(6, 10, 2, 18, 12, 16);
        g.generateTexture('bird', 38, 32);
        g.clear();
      }

      if (!this.textures.exists('pipe') || this.textures.get('pipe').key === '__MISSING') {
        g.fillStyle(0x00b894);
        g.fillRect(0, 0, 52, 32);
        g.fillStyle(0x00cec9);
        g.fillRect(2, 2, 48, 28);
        g.fillStyle(0x55efc4);
        g.fillRect(4, 4, 12, 24);
        g.generateTexture('pipe', 52, 32);
        g.clear();
      }

      if (!this.textures.exists('particle') || this.textures.get('particle').key === '__MISSING') {
        g.fillStyle(0xffffff);
        g.fillCircle(4, 4, 4);
        g.generateTexture('particle', 8, 8);
        g.clear();
      }

      g.destroy();

      this.drawBackground();

      this.pipeW = 52;
      this.gapSize = 140;
      this.pipeSpeed = 160;
      this.spawnInterval = 1800;
      this.score = 0;
      this.started = false;
      this.isDead = false;
      this.flapStrength = -280;
      this.birdRotMin = -30;
      this.birdRotMax = 70;

      this.bird = this.physics.add.sprite(80, H / 2, 'bird');
      this.bird.setDepth(10);
      this.bird.body.setSize(24, 22);
      this.bird.body.setOffset(6, 5);
      this.bird.body.allowGravity = false;
      this.bird.setVelocity(0, 0);

      this.tweens.add({
        targets: this.bird, y: H / 2 + 12, duration: 600,
        yoyo: true, repeat: -1, ease: 'Sine.easeInOut'
      });

      this.pipes = this.physics.add.group();
      this.scoreZones = this.physics.add.group();

      this.ground = this.add.rectangle(W / 2, H - 5, W, 10, 0x55efc4).setDepth(15);
      this.physics.add.existing(this.ground, true);

      this.ceiling = this.add.rectangle(W / 2, -5, W, 10, 0x74b9ff);
      this.physics.add.existing(this.ceiling, true);

      this.physics.add.overlap(this.bird, this.pipes, this.hitPipe, null, this);
      this.physics.add.overlap(this.bird, this.ground, this.hitPipe, null, this);
      this.physics.add.overlap(this.bird, this.scoreZones, this.addScore, null, this);

      this.particles = this.add.particles(0, 0, 'particle', {
        speed: { min: 30, max: 100 }, lifespan: 300, scale: { start: 0.8, end: 0 },
        emitting: false, quantity: 5, tint: [0xffeaa7, 0xfdcb6e, 0xffffff]
      });

      const ts = { fontFamily: 'Segoe UI', fontSize: '36px', fill: '#fff', stroke: '#2d3436', strokeThickness: 5 };
      this.scoreText = this.add.text(W / 2, 50, '0', ts).setOrigin(0.5).setDepth(20);

      this.msgText = this.add.text(W / 2, H / 2 - 50, 'Tap or SPACE to Start', {
        fontFamily: 'Segoe UI', fontSize: '22px', fill: '#fff',
        stroke: '#2d3436', strokeThickness: 4, align: 'center'
      }).setOrigin(0.5).setDepth(20);

      this.input.on('pointerdown', () => this.handleInput());
      this.input.keyboard.on('keydown-SPACE', () => this.handleInput());
    }

    drawBackground() {
      const W = this.W, H = this.H;
      const bg = this.add.graphics();

      bg.fillGradientStyle(0x74b9ff, 0x74b9ff, 0xa29bfe, 0xa29bfe);
      bg.fillRect(0, 0, W, H * 0.65);
      bg.fillGradientStyle(0xa29bfe, 0xa29bfe, 0x55efc4, 0x55efc4);
      bg.fillRect(0, H * 0.65, W, H * 0.35);

      for (let i = 0; i < 5; i++) {
        const cx = Phaser.Math.Between(30, W - 30);
        const cy = Phaser.Math.Between(30, 120);
        bg.fillStyle(0xffffff, 0.6);
        bg.fillEllipse(cx, cy, Phaser.Math.Between(30, 60), 18);
        bg.fillEllipse(cx + 15, cy - 6, 30, 14);
      }

      bg.fillStyle(0x55efc4);
      bg.fillRect(0, H - 40, W, 40);
      bg.fillStyle(0x00b894);
      bg.fillRect(0, H - 40, W, 4);

      for (let x = 0; x < W; x += 20) {
        bg.fillStyle(0x00cec9);
        bg.fillTriangle(x, H - 40, x + 10, H - 50, x + 20, H - 40);
      }
    }

    handleInput() {
      if (this.isDead) {
        this.scene.restart();
        return;
      }

      if (!this.started) {
        this.started = true;
        this.msgText.setVisible(false);
        this.tweens.killTweensOf(this.bird);
        this.bird.body.allowGravity = true;
        this.spawnTimer = this.time.addEvent({
          delay: this.spawnInterval, callback: this.spawnPipePair, callbackScope: this, loop: true
        });
        this.spawnPipePair();
      }

      this.flap();
    }

    flap() {
      if (this.isDead) return;
      this.bird.setVelocityY(this.flapStrength);
      if (this.cache.audio.exists('jumpSfx')) this.sound.play('jumpSfx', { volume: 0.5 });

      this.particles.emitParticleAt(this.bird.x - 10, this.bird.y + 5);

      this.tweens.add({
        targets: this.bird, scaleX: 1.15, scaleY: 0.85, duration: 80,
        yoyo: true, ease: 'Quad.easeOut'
      });
    }

    spawnPipePair() {
      if (this.isDead) return;

      const W = this.W, H = this.H;
      const minTop = 60;
      const maxTop = H - this.gapSize - 80;
      const topEnd = Phaser.Math.Between(minTop, maxTop);
      const botStart = topEnd + this.gapSize;

      const topPipe = this.createPipeColumn(W + 30, 0, topEnd, false);
      const botPipe = this.createPipeColumn(W + 30, botStart, H - botStart, true);

      this.pipes.add(topPipe);
      this.pipes.add(botPipe);
      topPipe.setVelocityX(-this.pipeSpeed);
      botPipe.setVelocityX(-this.pipeSpeed);
      topPipe.body.allowGravity = false;
      botPipe.body.allowGravity = false;

      const zone = this.add.rectangle(W + 30 + this.pipeW / 2 + 12, topEnd + this.gapSize / 2, 6, this.gapSize, 0x000000, 0);
      this.physics.add.existing(zone);
      zone.body.setVelocityX(-this.pipeSpeed);
      zone.body.allowGravity = false;
      zone.scored = false;
      this.scoreZones.add(zone);
    }

    createPipeColumn(x, y, height, flipped) {
      const container = this.add.graphics();
      const pw = this.pipeW;
      const capH = 24;

      container.fillStyle(0x00b894);
      if (flipped) {
        container.fillRect(x - pw / 2 + 3, y, pw - 6, height);
        container.fillRect(x - pw / 2, y, pw, capH);
        container.fillStyle(0x55efc4);
        container.fillRect(x - pw / 2 + 6, y + capH, 10, height - capH);
      } else {
        container.fillRect(x - pw / 2 + 3, y, pw - 6, height);
        container.fillRect(x - pw / 2, y + height - capH, pw, capH);
        container.fillStyle(0x55efc4);
        container.fillRect(x - pw / 2 + 6, y, 10, height - capH);
      }

      container.fillStyle(0x00cec9);
      if (flipped) {
        container.fillRect(x - pw / 2 + 2, y + 2, pw - 4, 3);
      } else {
        container.fillRect(x - pw / 2 + 2, y + height - capH + 2, pw - 4, 3);
      }

      container.setDepth(5);

      const hitbox = this.add.rectangle(x, y + height / 2, pw, height, 0x000000, 0);
      this.physics.add.existing(hitbox);
      hitbox.body.setImmovable(true);
      hitbox.gfx = container;
      hitbox.startX = x;
      hitbox.setDepth(5);

      return hitbox;
    }

    addScore(bird, zone) {
      if (zone.scored || this.isDead) return;
      zone.scored = true;
      this.score++;
      this.scoreText.setText('' + this.score);
      if (this.cache.audio.exists('coinSfx')) this.sound.play('coinSfx', { volume: 0.5 });

      this.tweens.add({
        targets: this.scoreText, scale: 1.3, duration: 100, yoyo: true, ease: 'Back.easeOut'
      });

      if (this.score % 5 === 0 && this.pipeSpeed < 260) {
        this.pipeSpeed += 10;
        if (this.gapSize > 110) this.gapSize -= 3;
      }
    }

    hitPipe() {
      if (this.isDead) return;
      this.isDead = true;

      if (this.cache.audio.exists('hitSfx')) this.sound.play('hitSfx', { volume: 0.6 });

      this.bird.setTint(0xff6b6b);
      this.bird.body.allowGravity = true;
      this.bird.setVelocity(0, -150);

      this.pipes.setVelocityX(0);
      this.scoreZones.setVelocityX(0);

      if (this.spawnTimer) this.spawnTimer.remove();

      this.cameras.main.shake(200, 0.012);

      this.time.delayedCall(600, () => {
        this.add.rectangle(this.W / 2, this.H / 2, this.W, this.H, 0x000000, 0.65).setDepth(25);

        this.add.text(this.W / 2, this.H / 2 - 60, 'GAME OVER', {
          fontFamily: 'Segoe UI', fontSize: '40px', fontStyle: 'bold',
          fill: '#ff6b6b', stroke: '#000', strokeThickness: 5
        }).setOrigin(0.5).setDepth(26);

        this.add.text(this.W / 2, this.H / 2, 'Score: ' + this.score, {
          fontFamily: 'Segoe UI', fontSize: '28px', fill: '#fff',
          stroke: '#000', strokeThickness: 4
        }).setOrigin(0.5).setDepth(26);

        this.add.text(this.W / 2, this.H / 2 + 60, 'Tap or SPACE to Restart', {
          fontFamily: 'Segoe UI', fontSize: '20px', fill: '#55efc4',
          stroke: '#000', strokeThickness: 3
        }).setOrigin(0.5).setDepth(26);
      });
    }

    update() {
      if (!this.started || this.isDead) return;

      if (this.bird.y < -20 || this.bird.y > this.H + 20) {
        this.hitPipe();
        return;
      }

      const vy = this.bird.body.velocity.y;
      const targetAngle = Phaser.Math.Clamp(vy * 0.15, this.birdRotMin, this.birdRotMax);
      this.bird.angle = Phaser.Math.Linear(this.bird.angle, targetAngle, 0.15);

      this.pipes.getChildren().forEach(pipe => {
        if (pipe.gfx) {
          const dx = pipe.x - pipe.startX;
          pipe.gfx.x = dx;
        }
        if (pipe.x < -80) {
          if (pipe.gfx) pipe.gfx.destroy();
          pipe.destroy();
        }
      });

      this.scoreZones.getChildren().forEach(zone => {
        if (zone.x < -80) zone.destroy();
      });
    }
  }

  new Phaser.Game({
    type: Phaser.AUTO,
    width: 400,
    height: 600,
    parent: 'game',
    backgroundColor: '#74b9ff',
    physics: {
      default: 'arcade',
      arcade: { gravity: { y: 700 }, debug: false }
    },
    scene: FlappyScene
  });
  </script>
</body>
</html>
