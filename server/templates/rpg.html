<!DOCTYPE html>
<html>
<head>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 50%, #52b788 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #game-container {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div id="game-container"></div>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.86.0/dist/phaser.min.js"></script>
  <script>
    const W = 1200, H = 1000, TOTAL_GEMS = 6;
    let player, cursors, gems, walls, spikes, npcs, hudText, hpBar;
    let gemCount = 0, hp = 5, maxHp = 5, invuln = 0, dialogText, dialogTimer;

    const config = {
      type: Phaser.AUTO, width: 800, height: 500,
      parent: 'game-container', backgroundColor: '#4a7c59',
      physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
      scene: { preload, create, update }
    };

    function preload() {
      this.load.image('hero', '/assets/sprites/rpg/hero.png');
      this.load.image('npc', '/assets/sprites/rpg/npc.png');
      this.load.image('wall', '/assets/sprites/rpg/wall.png');
      this.load.image('treasure', '/assets/sprites/rpg/treasure.png');
      this.load.image('heart', '/assets/sprites/common/heart.png');
      this.load.audio('coinSfx', '/assets/sounds/coin.wav');
      this.load.audio('hitSfx', '/assets/sounds/hit.wav');

      const g = this.make.graphics({ add: false });

      g.fillStyle(0x4a7c59); g.fillRect(0, 0, 64, 64);
      g.fillStyle(0x3e6b4a); g.fillRect(8, 5, 5, 4); g.fillRect(38, 30, 6, 3); g.fillRect(20, 48, 4, 5);
      g.fillStyle(0x5a9166); g.fillRect(28, 12, 6, 4); g.fillRect(50, 42, 5, 6);
      g.generateTexture('floor', 64, 64); g.clear();

      g.fillStyle(0xaa3333); g.fillRect(0, 0, 24, 24);
      g.fillStyle(0xcc4444); g.fillTriangle(4, 18, 8, 6, 12, 18);
      g.fillStyle(0xcc4444); g.fillTriangle(12, 18, 16, 6, 20, 18);
      g.generateTexture('spike', 24, 24); g.clear();

      g.destroy();
    }

    function create() {
      this.physics.world.setBounds(0, 0, W, H);
      for (let x = 0; x < W; x += 64)
        for (let y = 0; y < H; y += 64)
          this.add.image(x + 32, y + 32, 'floor');

      walls = this.physics.add.staticGroup();
      const aw = (x, y) => walls.create(x, y, 'wall');
      for (let x = 20; x < W; x += 40) { aw(x, 20); aw(x, H - 20); }
      for (let y = 60; y < H - 40; y += 40) { aw(20, y); aw(W - 20, y); }

      const hWalls = [[200, 560, 500], [400, 280, 800], [700, 380, 1020], [120, 720, 520], [680, 720, 920], [880, 560, 1100]];
      hWalls.forEach(([x1, y, x2]) => { for (let x = x1; x <= x2; x += 40) aw(x, y); });
      const vWalls = [[480, 100, 240], [320, 340, 520], [640, 440, 680], [960, 100, 340], [960, 440, 560], [800, 760, 940]];
      vWalls.forEach(([x, y1, y2]) => { for (let y = y1; y <= y2; y += 40) aw(x, y); });

      spikes = this.physics.add.staticGroup();
      [[260, 200], [560, 500], [850, 300], [150, 850], [1050, 650], [700, 900], [400, 650]].forEach(
        ([x, y]) => spikes.create(x, y, 'spike').setSize(18, 18).setDepth(2)
      );

      player = this.physics.add.sprite(100, 100, 'hero').setCollideWorldBounds(true).setDepth(5).setSize(22, 22);

      npcs = this.physics.add.staticGroup();
      [{ x: 200, y: 140, msg: "Welcome, brave hero!\nCollect all 6 gems!" },
       { x: 750, y: 820, msg: "Watch out for the\nred spike traps!" },
       { x: 1080, y: 140, msg: "The last gem hides\nin the southeast..." }
      ].forEach(d => { const n = npcs.create(d.x, d.y, 'npc').setDepth(4); n.msg = d.msg; });

      gems = this.physics.add.group();
      [[140, 480], [420, 180], [680, 640], [1060, 480], [1080, 900], [350, 900]].forEach(([x, y]) =>
        gems.create(x, y, 'treasure').setDepth(3)
      );
      this.tweens.add({ targets: gems.getChildren(), y: '-=6', duration: 800, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });

      this.physics.add.collider(player, walls);
      this.physics.add.overlap(player, gems, collectGem, null, this);
      this.physics.add.overlap(player, npcs, talkNPC, null, this);
      this.physics.add.overlap(player, spikes, hitSpike, null, this);

      hudText = this.add.text(16, 16, 'Gems: 0 / ' + TOTAL_GEMS, {
        fontSize: '18px', fontFamily: 'Segoe UI', fill: '#fff', stroke: '#222', strokeThickness: 3
      }).setScrollFactor(0).setDepth(10);
      this.add.text(660, 14, 'HP', {
        fontSize: '14px', fontFamily: 'Segoe UI', fill: '#fff', stroke: '#222', strokeThickness: 2
      }).setScrollFactor(0).setDepth(10);
      this.add.rectangle(730, 22, 104, 18, 0x222222, 0.7).setScrollFactor(0).setDepth(10);
      hpBar = this.add.rectangle(730, 22, 100, 14, 0x44dd66).setScrollFactor(0).setDepth(10);

      dialogText = this.add.text(400, 465, '', {
        fontSize: '15px', fontFamily: 'Segoe UI', fill: '#fff', stroke: '#000', strokeThickness: 3,
        backgroundColor: '#00000088', padding: { x: 14, y: 8 }, align: 'center'
      }).setScrollFactor(0).setDepth(10).setOrigin(0.5).setVisible(false);

      this.cameras.main.setBounds(0, 0, W, H);
      this.cameras.main.startFollow(player, true, 0.08, 0.08);
      cursors = this.input.keyboard.createCursorKeys();
    }

    function update(time) {
      if (hp <= 0) return;
      const speed = 180;
      player.setVelocity(0);
      if (cursors.left.isDown) player.setVelocityX(-speed);
      else if (cursors.right.isDown) player.setVelocityX(speed);
      if (cursors.up.isDown) player.setVelocityY(-speed);
      else if (cursors.down.isDown) player.setVelocityY(speed);
      if (player.body.velocity.length() > speed) player.body.velocity.normalize().scale(speed);
      if (invuln > 0) { invuln -= 16; player.setAlpha(Math.round(time / 100) % 2 ? 0.3 : 1); }
      else player.setAlpha(1);
    }

    function collectGem(p, gem) {
      this.sound.play('coinSfx');
      gem.destroy(); gemCount++;
      hudText.setText('Gems: ' + gemCount + ' / ' + TOTAL_GEMS);
      const fx = this.add.circle(gem.x, gem.y, 10, 0x00e5ff);
      this.tweens.add({ targets: fx, scale: 3, alpha: 0, duration: 350, onComplete: () => fx.destroy() });
      if (gems.countActive(true) === 0) showDialog.call(this, 'All gems collected!\nYou win!');
    }

    function hitSpike(p, spike) {
      if (invuln > 0) return;
      this.sound.play('hitSfx');
      hp--; invuln = 1200;
      hpBar.width = Math.max(0, (hp / maxHp) * 100);
      hpBar.fillColor = hp > 2 ? 0x44dd66 : hp > 1 ? 0xddaa22 : 0xdd4444;
      if (hp <= 0) {
        player.setTint(0xff0000).setAlpha(1);
        this.physics.pause();
        showDialog.call(this, 'You fell to the traps...\nRefresh to retry!');
      }
    }

    function talkNPC(p, npc) { showDialog.call(this, npc.msg); }

    function showDialog(msg) {
      dialogText.setText(msg).setVisible(true);
      if (dialogTimer) dialogTimer.remove();
      dialogTimer = this.time.delayedCall(2500, () => dialogText.setVisible(false));
    }

    new Phaser.Game(config);
  </script>
</body>
</html>
