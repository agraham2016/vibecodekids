<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Identity - VibeCodeKidz</title>
  <link href="/fonts/fonts.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    .logo {
      text-align: center;
      margin-bottom: 24px;
    }
    .logo h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .logo p { color: #888; font-size: 0.85rem; margin-top: 4px; }
    h2 { color: #333; font-size: 1.3rem; margin-bottom: 12px; }
    p { color: #555; line-height: 1.6; margin-bottom: 12px; font-size: 0.95rem; }
    .info-box {
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .info-box strong { color: #667eea; }
    .refund-note {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 0.9rem;
      color: #2e7d32;
    }
    #payment-element {
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      margin: 20px 0;
      min-height: 60px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(102,126,234,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-link {
      background: none;
      color: #667eea;
      text-decoration: underline;
      font-size: 0.9rem;
      margin-top: 12px;
      padding: 8px;
    }
    .error-msg { color: #d32f2f; font-size: 0.9rem; margin-top: 12px; display: none; }
    .success-card { text-align: center; }
    .success-card .icon { font-size: 3rem; margin-bottom: 16px; }
    .success-card h2 { color: #2e7d32; }
    .success-card .dashboard-link {
      display: inline-block;
      margin-top: 16px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 700;
    }
    .loading { text-align: center; padding: 40px; color: #888; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .or-divider {
      text-align: center;
      color: #aaa;
      font-size: 0.85rem;
      margin: 16px 0;
      position: relative;
    }
    .or-divider::before, .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #ddd;
    }
    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }
  </style>
</head>
<body>
  <div class="card">
    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Setting up verification...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
      <div style="text-align:center;padding:20px 0;">
        <div style="font-size:3rem;margin-bottom:16px;">&#x274C;</div>
        <h2 style="color:#d32f2f;">Something Went Wrong</h2>
        <p id="errorMessage" style="margin-top:12px;">Could not load the verification page.</p>
        <a href="/" class="btn btn-link">Go to VibeCodeKidz</a>
      </div>
    </div>

    <!-- Payment Form -->
    <div id="paymentState" class="hidden">
      <div class="logo">
        <h1>VibeCodeKidz</h1>
        <p>Parental Identity Verification</p>
      </div>

      <h2>Verify Your Identity</h2>
      <p>To comply with U.S. children's privacy law (COPPA), we use a small credit card charge to verify you are an adult authorized to consent for your child.</p>

      <div class="refund-note">
        <strong>&#x2705; The $0.50 charge is fully refunded immediately.</strong> This is only used to verify your identity — you will not be billed.
      </div>

      <div class="info-box">
        <strong>What happens next:</strong>
        <ul style="margin-top:8px;padding-left:20px;color:#555;font-size:0.9rem;">
          <li>A temporary $0.50 hold is placed on your card</li>
          <li>Your child's account is instantly approved</li>
          <li>The charge is refunded within seconds</li>
          <li>You'll receive a link to the Parent Command Center</li>
        </ul>
      </div>

      <div id="payment-element"></div>
      <p class="error-msg" id="paymentError"></p>

      <button id="submitBtn" class="btn btn-primary" onclick="handleSubmit()" disabled>
        Verify &amp; Approve ($0.50 — refunded)
      </button>

      <div class="or-divider">or</div>

      <button class="btn btn-link" id="emailApproveBtn" onclick="approveViaEmail()">
        Approve via email instead (lower verification)
      </button>
    </div>

    <!-- Success State -->
    <div id="successState" class="hidden success-card">
      <div class="icon">&#x2705;</div>
      <h2>Verification Complete!</h2>
      <p>The $0.50 charge has been refunded to your card. Your child can now log in and start creating games!</p>
      <p style="font-size:0.85rem;color:#888;">Verification method: Credit Card (high reliability)</p>
      <a id="dashboardLink" href="#" class="dashboard-link hidden">Open Parent Command Center</a>
      <br>
      <a href="/" class="btn btn-link" style="margin-top:20px;">Go to VibeCodeKidz</a>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    let stripe = null;
    let elements = null;
    let paymentElement = null;
    let clientSecret = null;
    let paymentIntentId = null;
    let consentToken = null;

    const params = new URLSearchParams(window.location.search);
    consentToken = params.get('token');

    function show(id) {
      ['loadingState','errorState','paymentState','successState'].forEach(s => {
        document.getElementById(s).classList.toggle('hidden', s !== id);
      });
    }

    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      show('errorState');
    }

    async function init() {
      if (!consentToken) {
        showError('No consent token found. Please use the link from your email.');
        return;
      }

      try {
        const configResp = await fetch('/api/parent/verify-charge/config');
        if (!configResp.ok) {
          showError('Payment verification is not available at this time.');
          return;
        }
        const config = await configResp.json();

        stripe = Stripe(config.publishableKey);

        const createResp = await fetch('/api/parent/verify-charge/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ consentToken }),
        });
        const createData = await createResp.json();

        if (!createResp.ok) {
          showError(createData.error || 'Could not start verification.');
          return;
        }

        clientSecret = createData.clientSecret;
        paymentIntentId = createData.paymentIntentId;

        elements = stripe.elements({ clientSecret, appearance: {
          theme: 'stripe',
          variables: { colorPrimary: '#667eea', borderRadius: '8px', fontFamily: 'Nunito, sans-serif' },
        }});

        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        paymentElement.on('ready', () => {
          document.getElementById('submitBtn').disabled = false;
        });
        paymentElement.on('change', (e) => {
          const errEl = document.getElementById('paymentError');
          if (e.error) {
            errEl.textContent = e.error.message;
            errEl.style.display = 'block';
          } else {
            errEl.style.display = 'none';
          }
        });

        show('paymentState');
      } catch (err) {
        showError('Could not connect to the verification service. Please try again later.');
      }
    }

    async function handleSubmit() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      const errEl = document.getElementById('paymentError');
      errEl.style.display = 'none';

      try {
        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {},
          redirect: 'if_required',
        });

        if (error) {
          errEl.textContent = error.message;
          errEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Verify & Approve ($0.50 — refunded)';
          return;
        }

        const confirmResp = await fetch('/api/parent/verify-charge/confirm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ consentToken, paymentIntentId }),
        });
        const confirmData = await confirmResp.json();

        if (!confirmResp.ok) {
          errEl.textContent = confirmData.error || 'Verification failed. Please try again.';
          errEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Verify & Approve ($0.50 — refunded)';
          return;
        }

        if (confirmData.dashboardUrl) {
          const link = document.getElementById('dashboardLink');
          link.href = confirmData.dashboardUrl;
          link.classList.remove('hidden');
        }

        show('successState');
      } catch (err) {
        errEl.textContent = 'An unexpected error occurred. Please try again.';
        errEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Verify & Approve ($0.50 — refunded)';
      }
    }

    function approveViaEmail() {
      if (!consentToken) return;
      window.location.href = '/api/parent/verify?token=' + encodeURIComponent(consentToken) + '&action=grant';
    }

    init();
  </script>
</body>
</html>
